# Copyright (C) 2020, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
---
apiVersion: v1
kind: Namespace
metadata:
  name: verrazzano-install
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: verrazzano-platform-operator
  namespace: verrazzano-install
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: verrazzano-platform-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: verrazzano-platform-operator
    namespace: verrazzano-install
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: verrazzano-platform-operator
  namespace: verrazzano-install
  labels:
    app: verrazzano-platform-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: verrazzano-platform-operator
  template:
    metadata:
      labels:
        app: verrazzano-platform-operator
    spec:
      initContainers:
        - name: webhook-init
          image: ghcr.io/verrazzano/verrazzano-platform-operator:0.9.0-20210129233531-0e15561
          imagePullPolicy: IfNotPresent
          args:
            - --zap-log-level=info
            - --init-webhooks=true
          env:
            - name: MODE
              value: INIT
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/webhook/certs
      containers:
        - name: verrazzano-platform-operator
          imagePullPolicy: IfNotPresent
          image: ghcr.io/verrazzano/verrazzano-platform-operator:0.9.0-20210129233531-0e15561
          ports:
            - containerPort: 9443
              name: webhook
              protocol: TCP
          startupProbe:
            httpGet:
              path: /validate-install-verrazzano-io-v1alpha1-verrazzano
              port: webhook
              scheme: HTTPS
              httpHeaders:
                - name: Content-Type
                  value: application/json
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 15
          args:
            - --zap-log-level=info
            - --enable-webhook-validation=true
          env:
            - name: MODE
              value: RUN_OPERATOR
            - name: VZ_INSTALL_IMAGE
              value: ghcr.io/verrazzano/verrazzano-platform-operator:0.9.0-20210129233531-0e15561
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/webhook/certs
              readOnly: true
          resources:
            requests:
              memory: 72Mi
      volumes:
        - name: webhook-certs
          emptyDir: {}
      serviceAccountName: verrazzano-platform-operator
---
apiVersion: v1
kind: Service
metadata:
  name: verrazzano-platform-operator
  namespace: verrazzano-install
  labels:
    app: verrazzano-platform-operator
spec:
  ports:
    - name: webhook
      port: 443
      targetPort: 9443
  selector:
    app: verrazzano-platform-operator
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: verrazzano-platform-operator
  labels:
    app: verrazzano-platform-operator
webhooks:
  - name: install.verrazzano.io
    clientConfig:
      service:
        name: verrazzano-platform-operator
        namespace: verrazzano-install
        path: /validate-install-verrazzano-io-v1alpha1-verrazzano
    rules:
      - apiGroups:
          - install.verrazzano.io
        apiVersions:
          - v1alpha1
        operations:
          - CREATE
          - UPDATE
        resources:
          - verrazzanos
    sideEffects: None
    failurePolicy: Fail
# Copyright (c) 2020, 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.2.5
  creationTimestamp: null
  name: verrazzanos.install.verrazzano.io
spec:
  group: install.verrazzano.io
  names:
    kind: Verrazzano
    listKind: VerrazzanoList
    plural: verrazzanos
    shortNames:
    - vz
    - vzs
    singular: verrazzano
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: The current status of the install/uninstall
      jsonPath: .status.conditions[-1:].type
      name: Status
      type: string
    - description: The current version of the Verrazzano installation
      jsonPath: .status.version
      name: Version
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Verrazzano is the Schema for the verrazzanos API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: VerrazzanoSpec defines the desired state of Verrazzano
            properties:
              components:
                description: Core specifies core Verrazzano configuration
                properties:
                  certManager:
                    description: CertManager contains the CertManager component configuration
                    properties:
                      certificate:
                        description: Certificate used for an install
                        properties:
                          acme:
                            description: ACME cert issuer
                            properties:
                              emailAddress:
                                description: email address
                                type: string
                              environment:
                                description: environment
                                type: string
                              provider:
                                description: Type of provider for ACME cert issuer.
                                type: string
                            required:
                            - provider
                            type: object
                          ca:
                            description: CA cert issuer
                            properties:
                              clusterResourceNamespace:
                                description: Namespace where secret is located for
                                  CA cert issuer
                                type: string
                              secretName:
                                description: Name of secret for CA cert issuer
                                type: string
                            required:
                            - clusterResourceNamespace
                            - secretName
                            type: object
                        type: object
                    type: object
                  dns:
                    description: DNS contains the DNS component configuration
                    properties:
                      external:
                        description: DNS type of external. For example, OLCNE uses
                          this type.
                        properties:
                          suffix:
                            description: DNS suffix appended to EnviromentName to
                              form DNS name
                            type: string
                        required:
                        - suffix
                        type: object
                      oci:
                        description: DNS type of OCI (Oracle Cloud Infrastructure)
                        properties:
                          dnsZoneCompartmentOCID:
                            type: string
                          dnsZoneName:
                            type: string
                          dnsZoneOCID:
                            type: string
                          ociConfigSecret:
                            type: string
                        required:
                        - dnsZoneCompartmentOCID
                        - dnsZoneName
                        - dnsZoneOCID
                        - ociConfigSecret
                        type: object
                      xip.io:
                        description: DNS type of xip.io.  This is the default.
                        type: object
                    type: object
                  ingress:
                    description: Ingress contains the ingress-nginx component configuration
                    properties:
                      nginxInstallArgs:
                        description: Arguments for installing NGINX
                        items:
                          description: InstallArgs identifies a name/value or name/value
                            list needed for install. Value and ValueList cannot both
                            be specified.
                          properties:
                            name:
                              description: Name of install argument
                              type: string
                            setString:
                              description: If the Value is a literal string
                              type: boolean
                            value:
                              description: Value for named install argument
                              type: string
                            valueList:
                              description: List of values for named install argument
                              items:
                                type: string
                              type: array
                          required:
                          - name
                          type: object
                        type: array
                      ports:
                        description: Ports to be used for NGINX
                        items:
                          description: ServicePort contains information on service's
                            port.
                          properties:
                            appProtocol:
                              description: The application protocol for this port.
                                This field follows standard Kubernetes label syntax.
                                Un-prefixed names are reserved for IANA standard service
                                names (as per RFC-6335 and http://www.iana.org/assignments/service-names).
                                Non-standard protocols should use prefixed names such
                                as mycompany.com/my-custom-protocol. Field can be
                                enabled with ServiceAppProtocol feature gate.
                              type: string
                            name:
                              description: The name of this port within the service.
                                This must be a DNS_LABEL. All ports within a ServiceSpec
                                must have unique names. When considering the endpoints
                                for a Service, this must match the 'name' field in
                                the EndpointPort. Optional if only one ServicePort
                                is defined on this service.
                              type: string
                            nodePort:
                              description: 'The port on each node on which this service
                                is exposed when type=NodePort or LoadBalancer. Usually
                                assigned by the system. If specified, it will be allocated
                                to the service if unused or else creation of the service
                                will fail. Default is to auto-allocate a port if the
                                ServiceType of this Service requires one. More info:
                                https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport'
                              format: int32
                              type: integer
                            port:
                              description: The port that will be exposed by this service.
                              format: int32
                              type: integer
                            protocol:
                              description: The IP protocol for this port. Supports
                                "TCP", "UDP", and "SCTP". Default is TCP.
                              type: string
                            targetPort:
                              anyOf:
                              - type: integer
                              - type: string
                              description: 'Number or name of the port to access on
                                the pods targeted by the service. Number must be in
                                the range 1 to 65535. Name must be an IANA_SVC_NAME.
                                If this is a string, it will be looked up as a named
                                port in the target Pod''s container ports. If this
                                is not specified, the value of the ''port'' field
                                is used (an identity map). This field is ignored for
                                services with clusterIP=None, and should be omitted
                                or set equal to the ''port'' field. More info: https://kubernetes.io/docs/concepts/services-networking/service/#defining-a-service'
                              x-kubernetes-int-or-string: true
                          required:
                          - port
                          type: object
                        type: array
                      type:
                        description: Type of ingress.  Default is LoadBalancer
                        type: string
                    type: object
                  istio:
                    description: Istio contains the istio component configuration
                    properties:
                      istioInstallArgs:
                        description: Arguments for installing Istio
                        items:
                          description: InstallArgs identifies a name/value or name/value
                            list needed for install. Value and ValueList cannot both
                            be specified.
                          properties:
                            name:
                              description: Name of install argument
                              type: string
                            setString:
                              description: If the Value is a literal string
                              type: boolean
                            value:
                              description: Value for named install argument
                              type: string
                            valueList:
                              description: List of values for named install argument
                              items:
                                type: string
                              type: array
                          required:
                          - name
                          type: object
                        type: array
                    type: object
                  keycloak:
                    description: Keycloak contains the Keycloak component configuration
                    properties:
                      keycloakInstallArgs:
                        description: Arguments for installing Keycloak
                        items:
                          description: InstallArgs identifies a name/value or name/value
                            list needed for install. Value and ValueList cannot both
                            be specified.
                          properties:
                            name:
                              description: Name of install argument
                              type: string
                            setString:
                              description: If the Value is a literal string
                              type: boolean
                            value:
                              description: Value for named install argument
                              type: string
                            valueList:
                              description: List of values for named install argument
                              items:
                                type: string
                              type: array
                          required:
                          - name
                          type: object
                        type: array
                      mysql:
                        description: MySQL contains the MySQL component configuration
                          needed for Keycloak
                        properties:
                          mysqlInstallArgs:
                            description: Arguments for installing MySQL
                            items:
                              description: InstallArgs identifies a name/value or
                                name/value list needed for install. Value and ValueList
                                cannot both be specified.
                              properties:
                                name:
                                  description: Name of install argument
                                  type: string
                                setString:
                                  description: If the Value is a literal string
                                  type: boolean
                                value:
                                  description: Value for named install argument
                                  type: string
                                valueList:
                                  description: List of values for named install argument
                                  items:
                                    type: string
                                  type: array
                              required:
                              - name
                              type: object
                            type: array
                          volumeTemplate:
                            description: VolumeTemplate Name of the volume template
                              to use for storage configuration
                            type: string
                        type: object
                    type: object
                  oam:
                    description: OAM contains the OAM component configuration
                    properties:
                      enabled:
                        description: Argument to enable installation of OAM components
                        type: boolean
                    type: object
                type: object
              defaultVolumeTemplate:
                description: DefaultVolumeTemplate Specifies the default storage template
                  to use if not overridden by a specific component
                type: string
              environmentName:
                description: EnvironmentName identifies install environment.  Default
                  environment name is "default".
                type: string
              profile:
                description: Profile is the name of the profile to install.  Default
                  is "prod".
                type: string
              version:
                description: Version is the Verrazzano version
                type: string
              volumeTemplates:
                description: VolumeTemplates Defines storage options that can be shared
                  by other Verrazzano components in the resource; if none are defined
                  EmptyDir volumes are assumed by default
                items:
                  description: VolumeTemplate Allows defining a set of PersistentVolumeClaim
                    characteristics that can be referenced by other components for
                    storage configuration
                  properties:
                    name:
                      description: Name The name of the template
                      type: string
                    spec:
                      description: Spec PersistentVolumeClaim template configuration
                      properties:
                        accessModes:
                          description: 'AccessModes contains the desired access modes
                            the volume should have. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1'
                          items:
                            type: string
                          type: array
                        dataSource:
                          description: 'This field can be used to specify either:
                            * An existing VolumeSnapshot object (snapshot.storage.k8s.io/VolumeSnapshot
                            - Beta) * An existing PVC (PersistentVolumeClaim) * An
                            existing custom resource/object that implements data population
                            (Alpha) In order to use VolumeSnapshot object types, the
                            appropriate feature gate must be enabled (VolumeSnapshotDataSource
                            or AnyVolumeDataSource) If the provisioner or an external
                            controller can support the specified data source, it will
                            create a new volume based on the contents of the specified
                            data source. If the specified data source is not supported,
                            the volume will not be created and the failure will be
                            reported as an event. In the future, we plan to support
                            more data source types and the behavior of the provisioner
                            may change.'
                          properties:
                            apiGroup:
                              description: APIGroup is the group for the resource
                                being referenced. If APIGroup is not specified, the
                                specified Kind must be in the core API group. For
                                any other third-party types, APIGroup is required.
                              type: string
                            kind:
                              description: Kind is the type of resource being referenced
                              type: string
                            name:
                              description: Name is the name of resource being referenced
                              type: string
                          required:
                          - kind
                          - name
                          type: object
                        resources:
                          description: 'Resources represents the minimum resources
                            the volume should have. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#resources'
                          properties:
                            limits:
                              additionalProperties:
                                anyOf:
                                - type: integer
                                - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Limits describes the maximum amount of
                                compute resources allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                              type: object
                            requests:
                              additionalProperties:
                                anyOf:
                                - type: integer
                                - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Requests describes the minimum amount
                                of compute resources required. If Requests is omitted
                                for a container, it defaults to Limits if that is
                                explicitly specified, otherwise to an implementation-defined
                                value. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                              type: object
                          type: object
                        selector:
                          description: A label query over volumes to consider for
                            binding.
                          properties:
                            matchExpressions:
                              description: matchExpressions is a list of label selector
                                requirements. The requirements are ANDed.
                              items:
                                description: A label selector requirement is a selector
                                  that contains values, a key, and an operator that
                                  relates the key and values.
                                properties:
                                  key:
                                    description: key is the label key that the selector
                                      applies to.
                                    type: string
                                  operator:
                                    description: operator represents a key's relationship
                                      to a set of values. Valid operators are In,
                                      NotIn, Exists and DoesNotExist.
                                    type: string
                                  values:
                                    description: values is an array of string values.
                                      If the operator is In or NotIn, the values array
                                      must be non-empty. If the operator is Exists
                                      or DoesNotExist, the values array must be empty.
                                      This array is replaced during a strategic merge
                                      patch.
                                    items:
                                      type: string
                                    type: array
                                required:
                                - key
                                - operator
                                type: object
                              type: array
                            matchLabels:
                              additionalProperties:
                                type: string
                              description: matchLabels is a map of {key,value} pairs.
                                A single {key,value} in the matchLabels map is equivalent
                                to an element of matchExpressions, whose key field
                                is "key", the operator is "In", and the values array
                                contains only "value". The requirements are ANDed.
                              type: object
                          type: object
                        storageClassName:
                          description: 'Name of the StorageClass required by the claim.
                            More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#class-1'
                          type: string
                        volumeMode:
                          description: volumeMode defines what type of volume is required
                            by the claim. Value of Filesystem is implied when not
                            included in claim spec.
                          type: string
                        volumeName:
                          description: VolumeName is the binding reference to the
                            PersistentVolume backing this claim.
                          type: string
                      type: object
                  required:
                  - name
                  type: object
                type: array
            type: object
          status:
            description: VerrazzanoStatus defines the observed state of Verrazzano
            properties:
              conditions:
                description: The latest available observations of an object's current
                  state.
                items:
                  description: Condition describes current state of an install.
                  properties:
                    lastTransitionTime:
                      description: Last time the condition transitioned from one status
                        to another.
                      type: string
                    message:
                      description: Human readable message indicating details about
                        last transition.
                      type: string
                    status:
                      description: Status of the condition, one of True, False, Unknown.
                      type: string
                    type:
                      description: Type of condition.
                      type: string
                  required:
                  - status
                  - type
                  type: object
                type: array
              state:
                description: State of the Verrazzano custom resource
                type: string
              version:
                description: The version of Verrazzano that is installed
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
